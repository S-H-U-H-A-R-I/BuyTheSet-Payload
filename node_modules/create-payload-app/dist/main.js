"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "Main", {
    enumerable: true,
    get: function() {
        return Main;
    }
});
const _slugify = /*#__PURE__*/ _interop_require_default(require("@sindresorhus/slugify"));
const _arg = /*#__PURE__*/ _interop_require_default(require("arg"));
const _commandexists = /*#__PURE__*/ _interop_require_default(require("command-exists"));
const _createproject = require("./lib/create-project");
const _generatesecret = require("./lib/generate-secret");
const _parseprojectname = require("./lib/parse-project-name");
const _parsetemplate = require("./lib/parse-template");
const _selectdb = require("./lib/select-db");
const _templates = require("./lib/templates");
const _writeenvfile = require("./lib/write-env-file");
const _log = require("./utils/log");
const _messages = require("./utils/messages");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
class Main {
    args;
    constructor(){
        // @ts-expect-error bad typings
        this.args = (0, _arg.default)({
            '--db': String,
            '--help': Boolean,
            '--name': String,
            '--secret': String,
            '--template': String,
            // Package manager
            '--no-deps': Boolean,
            '--use-npm': Boolean,
            '--use-pnpm': Boolean,
            '--use-yarn': Boolean,
            // Flags
            '--beta': Boolean,
            '--dry-run': Boolean,
            // Aliases
            '-d': '--db',
            '-h': '--help',
            '-n': '--name',
            '-t': '--template'
        }, {
            permissive: true
        });
    }
    async init() {
        try {
            if (this.args['--help']) {
                console.log((0, _messages.helpMessage)());
                process.exit(0);
            }
            const templateArg = this.args['--template'];
            if (templateArg) {
                const valid = (0, _templates.validateTemplate)(templateArg);
                if (!valid) {
                    console.log((0, _messages.helpMessage)());
                    process.exit(1);
                }
            }
            console.log(_messages.welcomeMessage);
            const projectName = await (0, _parseprojectname.parseProjectName)(this.args);
            const validTemplates = (0, _templates.getValidTemplates)();
            const template = await (0, _parsetemplate.parseTemplate)(this.args, validTemplates);
            const projectDir = projectName === '.' ? process.cwd() : `./${(0, _slugify.default)(projectName)}`;
            const packageManager = await getPackageManager(this.args);
            if (template.type !== 'plugin') {
                const dbDetails = await (0, _selectdb.selectDb)(this.args, projectName);
                const payloadSecret = (0, _generatesecret.generateSecret)();
                if (!this.args['--dry-run']) {
                    await (0, _createproject.createProject)({
                        cliArgs: this.args,
                        dbDetails,
                        packageManager,
                        projectDir,
                        projectName,
                        template
                    });
                    await (0, _writeenvfile.writeEnvFile)({
                        databaseUri: dbDetails.dbUri,
                        payloadSecret,
                        projectDir,
                        template
                    });
                }
            } else {
                if (!this.args['--dry-run']) {
                    await (0, _createproject.createProject)({
                        cliArgs: this.args,
                        packageManager,
                        projectDir,
                        projectName,
                        template
                    });
                }
            }
            (0, _log.success)('Payload project successfully created');
            console.log((0, _messages.successMessage)(projectDir, packageManager));
        } catch (error) {
            console.log(error);
        }
    }
}
async function getPackageManager(args) {
    let packageManager = 'npm';
    if (args['--use-npm']) {
        packageManager = 'npm';
    } else if (args['--use-yarn']) {
        packageManager = 'yarn';
    } else if (args['--use-pnpm']) {
        packageManager = 'pnpm';
    } else {
        try {
            if (await (0, _commandexists.default)('yarn')) {
                packageManager = 'yarn';
            } else if (await (0, _commandexists.default)('pnpm')) {
                packageManager = 'pnpm';
            }
        } catch (error) {
            packageManager = 'npm';
        }
    }
    return packageManager;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBzbHVnaWZ5IGZyb20gJ0BzaW5kcmVzb3JodXMvc2x1Z2lmeSdcbmltcG9ydCBhcmcgZnJvbSAnYXJnJ1xuaW1wb3J0IGNvbW1hbmRFeGlzdHMgZnJvbSAnY29tbWFuZC1leGlzdHMnXG5cbmltcG9ydCB0eXBlIHsgQ2xpQXJncywgUGFja2FnZU1hbmFnZXIgfSBmcm9tICcuL3R5cGVzJ1xuXG5pbXBvcnQgeyBjcmVhdGVQcm9qZWN0IH0gZnJvbSAnLi9saWIvY3JlYXRlLXByb2plY3QnXG5pbXBvcnQgeyBnZW5lcmF0ZVNlY3JldCB9IGZyb20gJy4vbGliL2dlbmVyYXRlLXNlY3JldCdcbmltcG9ydCB7IHBhcnNlUHJvamVjdE5hbWUgfSBmcm9tICcuL2xpYi9wYXJzZS1wcm9qZWN0LW5hbWUnXG5pbXBvcnQgeyBwYXJzZVRlbXBsYXRlIH0gZnJvbSAnLi9saWIvcGFyc2UtdGVtcGxhdGUnXG5pbXBvcnQgeyBzZWxlY3REYiB9IGZyb20gJy4vbGliL3NlbGVjdC1kYidcbmltcG9ydCB7IGdldFZhbGlkVGVtcGxhdGVzLCB2YWxpZGF0ZVRlbXBsYXRlIH0gZnJvbSAnLi9saWIvdGVtcGxhdGVzJ1xuaW1wb3J0IHsgd3JpdGVFbnZGaWxlIH0gZnJvbSAnLi9saWIvd3JpdGUtZW52LWZpbGUnXG5pbXBvcnQgeyBzdWNjZXNzIH0gZnJvbSAnLi91dGlscy9sb2cnXG5pbXBvcnQgeyBoZWxwTWVzc2FnZSwgc3VjY2Vzc01lc3NhZ2UsIHdlbGNvbWVNZXNzYWdlIH0gZnJvbSAnLi91dGlscy9tZXNzYWdlcydcblxuZXhwb3J0IGNsYXNzIE1haW4ge1xuICBhcmdzOiBDbGlBcmdzXG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgLy8gQHRzLWV4cGVjdC1lcnJvciBiYWQgdHlwaW5nc1xuICAgIHRoaXMuYXJncyA9IGFyZyhcbiAgICAgIHtcbiAgICAgICAgJy0tZGInOiBTdHJpbmcsXG4gICAgICAgICctLWhlbHAnOiBCb29sZWFuLFxuICAgICAgICAnLS1uYW1lJzogU3RyaW5nLFxuICAgICAgICAnLS1zZWNyZXQnOiBTdHJpbmcsXG4gICAgICAgICctLXRlbXBsYXRlJzogU3RyaW5nLFxuXG4gICAgICAgIC8vIFBhY2thZ2UgbWFuYWdlclxuICAgICAgICAnLS1uby1kZXBzJzogQm9vbGVhbixcbiAgICAgICAgJy0tdXNlLW5wbSc6IEJvb2xlYW4sXG4gICAgICAgICctLXVzZS1wbnBtJzogQm9vbGVhbixcbiAgICAgICAgJy0tdXNlLXlhcm4nOiBCb29sZWFuLFxuXG4gICAgICAgIC8vIEZsYWdzXG4gICAgICAgICctLWJldGEnOiBCb29sZWFuLFxuICAgICAgICAnLS1kcnktcnVuJzogQm9vbGVhbixcblxuICAgICAgICAvLyBBbGlhc2VzXG4gICAgICAgICctZCc6ICctLWRiJyxcbiAgICAgICAgJy1oJzogJy0taGVscCcsXG4gICAgICAgICctbic6ICctLW5hbWUnLFxuICAgICAgICAnLXQnOiAnLS10ZW1wbGF0ZScsXG4gICAgICB9LFxuICAgICAgeyBwZXJtaXNzaXZlOiB0cnVlIH0sXG4gICAgKVxuICB9XG5cbiAgYXN5bmMgaW5pdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgaWYgKHRoaXMuYXJnc1snLS1oZWxwJ10pIHtcbiAgICAgICAgY29uc29sZS5sb2coaGVscE1lc3NhZ2UoKSlcbiAgICAgICAgcHJvY2Vzcy5leGl0KDApXG4gICAgICB9XG4gICAgICBjb25zdCB0ZW1wbGF0ZUFyZyA9IHRoaXMuYXJnc1snLS10ZW1wbGF0ZSddXG4gICAgICBpZiAodGVtcGxhdGVBcmcpIHtcbiAgICAgICAgY29uc3QgdmFsaWQgPSB2YWxpZGF0ZVRlbXBsYXRlKHRlbXBsYXRlQXJnKVxuICAgICAgICBpZiAoIXZhbGlkKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coaGVscE1lc3NhZ2UoKSlcbiAgICAgICAgICBwcm9jZXNzLmV4aXQoMSlcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjb25zb2xlLmxvZyh3ZWxjb21lTWVzc2FnZSlcbiAgICAgIGNvbnN0IHByb2plY3ROYW1lID0gYXdhaXQgcGFyc2VQcm9qZWN0TmFtZSh0aGlzLmFyZ3MpXG4gICAgICBjb25zdCB2YWxpZFRlbXBsYXRlcyA9IGdldFZhbGlkVGVtcGxhdGVzKClcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gYXdhaXQgcGFyc2VUZW1wbGF0ZSh0aGlzLmFyZ3MsIHZhbGlkVGVtcGxhdGVzKVxuXG4gICAgICBjb25zdCBwcm9qZWN0RGlyID0gcHJvamVjdE5hbWUgPT09ICcuJyA/IHByb2Nlc3MuY3dkKCkgOiBgLi8ke3NsdWdpZnkocHJvamVjdE5hbWUpfWBcbiAgICAgIGNvbnN0IHBhY2thZ2VNYW5hZ2VyID0gYXdhaXQgZ2V0UGFja2FnZU1hbmFnZXIodGhpcy5hcmdzKVxuXG4gICAgICBpZiAodGVtcGxhdGUudHlwZSAhPT0gJ3BsdWdpbicpIHtcbiAgICAgICAgY29uc3QgZGJEZXRhaWxzID0gYXdhaXQgc2VsZWN0RGIodGhpcy5hcmdzLCBwcm9qZWN0TmFtZSlcbiAgICAgICAgY29uc3QgcGF5bG9hZFNlY3JldCA9IGdlbmVyYXRlU2VjcmV0KClcbiAgICAgICAgaWYgKCF0aGlzLmFyZ3NbJy0tZHJ5LXJ1biddKSB7XG4gICAgICAgICAgYXdhaXQgY3JlYXRlUHJvamVjdCh7XG4gICAgICAgICAgICBjbGlBcmdzOiB0aGlzLmFyZ3MsXG4gICAgICAgICAgICBkYkRldGFpbHMsXG4gICAgICAgICAgICBwYWNrYWdlTWFuYWdlcixcbiAgICAgICAgICAgIHByb2plY3REaXIsXG4gICAgICAgICAgICBwcm9qZWN0TmFtZSxcbiAgICAgICAgICAgIHRlbXBsYXRlLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgYXdhaXQgd3JpdGVFbnZGaWxlKHtcbiAgICAgICAgICAgIGRhdGFiYXNlVXJpOiBkYkRldGFpbHMuZGJVcmksXG4gICAgICAgICAgICBwYXlsb2FkU2VjcmV0LFxuICAgICAgICAgICAgcHJvamVjdERpcixcbiAgICAgICAgICAgIHRlbXBsYXRlLFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghdGhpcy5hcmdzWyctLWRyeS1ydW4nXSkge1xuICAgICAgICAgIGF3YWl0IGNyZWF0ZVByb2plY3Qoe1xuICAgICAgICAgICAgY2xpQXJnczogdGhpcy5hcmdzLFxuICAgICAgICAgICAgcGFja2FnZU1hbmFnZXIsXG4gICAgICAgICAgICBwcm9qZWN0RGlyLFxuICAgICAgICAgICAgcHJvamVjdE5hbWUsXG4gICAgICAgICAgICB0ZW1wbGF0ZSxcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHN1Y2Nlc3MoJ1BheWxvYWQgcHJvamVjdCBzdWNjZXNzZnVsbHkgY3JlYXRlZCcpXG4gICAgICBjb25zb2xlLmxvZyhzdWNjZXNzTWVzc2FnZShwcm9qZWN0RGlyLCBwYWNrYWdlTWFuYWdlcikpXG4gICAgfSBjYXRjaCAoZXJyb3I6IHVua25vd24pIHtcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yKVxuICAgIH1cbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRQYWNrYWdlTWFuYWdlcihhcmdzOiBDbGlBcmdzKTogUHJvbWlzZTxQYWNrYWdlTWFuYWdlcj4ge1xuICBsZXQgcGFja2FnZU1hbmFnZXI6IFBhY2thZ2VNYW5hZ2VyID0gJ25wbSdcblxuICBpZiAoYXJnc1snLS11c2UtbnBtJ10pIHtcbiAgICBwYWNrYWdlTWFuYWdlciA9ICducG0nXG4gIH0gZWxzZSBpZiAoYXJnc1snLS11c2UteWFybiddKSB7XG4gICAgcGFja2FnZU1hbmFnZXIgPSAneWFybidcbiAgfSBlbHNlIGlmIChhcmdzWyctLXVzZS1wbnBtJ10pIHtcbiAgICBwYWNrYWdlTWFuYWdlciA9ICdwbnBtJ1xuICB9IGVsc2Uge1xuICAgIHRyeSB7XG4gICAgICBpZiAoYXdhaXQgY29tbWFuZEV4aXN0cygneWFybicpKSB7XG4gICAgICAgIHBhY2thZ2VNYW5hZ2VyID0gJ3lhcm4nXG4gICAgICB9IGVsc2UgaWYgKGF3YWl0IGNvbW1hbmRFeGlzdHMoJ3BucG0nKSkge1xuICAgICAgICBwYWNrYWdlTWFuYWdlciA9ICdwbnBtJ1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yOiB1bmtub3duKSB7XG4gICAgICBwYWNrYWdlTWFuYWdlciA9ICducG0nXG4gICAgfVxuICB9XG4gIHJldHVybiBwYWNrYWdlTWFuYWdlclxufVxuIl0sIm5hbWVzIjpbIk1haW4iLCJhcmdzIiwiY29uc3RydWN0b3IiLCJhcmciLCJTdHJpbmciLCJCb29sZWFuIiwicGVybWlzc2l2ZSIsImluaXQiLCJjb25zb2xlIiwibG9nIiwiaGVscE1lc3NhZ2UiLCJwcm9jZXNzIiwiZXhpdCIsInRlbXBsYXRlQXJnIiwidmFsaWQiLCJ2YWxpZGF0ZVRlbXBsYXRlIiwid2VsY29tZU1lc3NhZ2UiLCJwcm9qZWN0TmFtZSIsInBhcnNlUHJvamVjdE5hbWUiLCJ2YWxpZFRlbXBsYXRlcyIsImdldFZhbGlkVGVtcGxhdGVzIiwidGVtcGxhdGUiLCJwYXJzZVRlbXBsYXRlIiwicHJvamVjdERpciIsImN3ZCIsInNsdWdpZnkiLCJwYWNrYWdlTWFuYWdlciIsImdldFBhY2thZ2VNYW5hZ2VyIiwidHlwZSIsImRiRGV0YWlscyIsInNlbGVjdERiIiwicGF5bG9hZFNlY3JldCIsImdlbmVyYXRlU2VjcmV0IiwiY3JlYXRlUHJvamVjdCIsImNsaUFyZ3MiLCJ3cml0ZUVudkZpbGUiLCJkYXRhYmFzZVVyaSIsImRiVXJpIiwic3VjY2VzcyIsInN1Y2Nlc3NNZXNzYWdlIiwiZXJyb3IiLCJjb21tYW5kRXhpc3RzIl0sIm1hcHBpbmdzIjoiOzs7OytCQWdCYUE7OztlQUFBQTs7O2dFQWhCTzs0REFDSjtzRUFDVTsrQkFJSTtnQ0FDQztrQ0FDRTsrQkFDSDswQkFDTDsyQkFDMkI7OEJBQ3ZCO3FCQUNMOzBCQUNvQzs7Ozs7O0FBRXJELE1BQU1BO0lBQ1hDLEtBQWE7SUFFYkMs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